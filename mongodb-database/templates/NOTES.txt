MongoDB ha sido desplegado exitosamente.

Release: {{ .Release.Name }}
Namespace: {{ .Release.Namespace }}
Architecture: {{ .Values.architecture }}

Informacion de conexion:

  Host: {{ include "mongodb-database.fullname" . }}.{{ .Release.Namespace }}.svc.cluster.local
  Port: {{ .Values.service.port }}
  {{- if .Values.auth.enabled }}
  Root Username: {{ .Values.auth.rootUser }}
  Database: {{ .Values.auth.database }}
  App Username: {{ .Values.auth.username }}
  {{- end }}

{{- if .Values.auth.enabled }}

Para obtener las credenciales:

  Root Password:
    export MONGODB_ROOT_PASSWORD=$(kubectl get secret --namespace {{ .Release.Namespace }} {{ include "mongodb-database.secretName" . }} -o jsonpath="{.data.mongodb-root-password}" | base64 -d)
    echo "Root Password: $MONGODB_ROOT_PASSWORD"

  App User Password:
    export MONGODB_PASSWORD=$(kubectl get secret --namespace {{ .Release.Namespace }} {{ include "mongodb-database.secretName" . }} -o jsonpath="{.data.mongodb-password}" | base64 -d)
    echo "App Password: $MONGODB_PASSWORD"
{{- end }}

Para conectarse a MongoDB:

1. Usando el cliente mongo desde un pod temporal:

   kubectl run --namespace {{ .Release.Namespace }} mongodb-client --rm --tty -i --restart='Never' \
     --image {{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }} \
     {{- if .Values.auth.enabled }}
     --env="MONGODB_ROOT_PASSWORD=$MONGODB_ROOT_PASSWORD" \
     -- mongosh admin --host {{ include "mongodb-database.fullname" . }} --authenticationDatabase admin \
        -u {{ .Values.auth.rootUser }} -p $MONGODB_ROOT_PASSWORD
     {{- else }}
     -- mongosh --host {{ include "mongodb-database.fullname" . }}
     {{- end }}

2. Connection string para aplicaciones:

   {{- if .Values.auth.enabled }}
   mongodb://{{ .Values.auth.username }}:$MONGODB_PASSWORD@{{ include "mongodb-database.fullname" . }}.{{ .Release.Namespace }}.svc.cluster.local:{{ .Values.service.port }}/{{ .Values.auth.database }}
   {{- else }}
   mongodb://{{ include "mongodb-database.fullname" . }}.{{ .Release.Namespace }}.svc.cluster.local:{{ .Values.service.port }}/{{ .Values.auth.database }}
   {{- end }}

3. Port-forward para acceso local:

   kubectl port-forward --namespace {{ .Release.Namespace }} svc/{{ include "mongodb-database.fullname" . }} 27017:{{ .Values.service.port }}

   Luego conectate:
   {{- if .Values.auth.enabled }}
   mongosh "mongodb://{{ .Values.auth.rootUser }}:$MONGODB_ROOT_PASSWORD@localhost:27017/admin"
   {{- else }}
   mongosh "mongodb://localhost:27017/{{ .Values.auth.database }}"
   {{- end }}

Comandos utiles:

  Ver estado del StatefulSet:
    kubectl get statefulset -n {{ .Release.Namespace }} {{ include "mongodb-database.fullname" . }}

  Ver pods:
    kubectl get pods -n {{ .Release.Namespace }} -l app.kubernetes.io/instance={{ .Release.Name }}

  Ver logs:
    kubectl logs -n {{ .Release.Namespace }} -l app.kubernetes.io/instance={{ .Release.Name }} -f

  {{- if .Values.persistence.enabled }}
  
  Verificar volumenes:
    kubectl get pvc -n {{ .Release.Namespace }}
  {{- end }}

  {{- if .Values.metrics.enabled }}
  
  Metricas disponibles en:
    http://{{ include "mongodb-database.fullname" . }}.{{ .Release.Namespace }}.svc.cluster.local:{{ .Values.metrics.port }}/metrics
  {{- end }}

Para administracion:

  Crear un usuario adicional:
    db.createUser({
      user: "newuser",
      pwd: "password",
      roles: [{ role: "readWrite", db: "{{ .Values.auth.database }}" }]
    })

  Ver bases de datos:
    show dbs

  Seleccionar base de datos:
    use {{ .Values.auth.database }}

  Ver colecciones:
    show collections
